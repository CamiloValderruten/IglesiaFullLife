<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Presentation | Full Life Ministry</title>
	<link rel="icon" href="/static/favicon.png">
	<meta
			 content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
			 name="viewport">
	<link rel="stylesheet"
	      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet"
	      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<style>
		body {
			padding-top: 70px;
		}

		.category, .category-title {
			text-transform: capitalize;
		}

		#timer {
			font-size: 50px;
			text-align: center;
			padding-top: 20px;
			padding-bottom: 50px;
		}
	</style>
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse"
			        data-target="#mobile-menu">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">PresentationCenter</a>
		</div>
		<div class="collapse navbar-collapse" id="mobile-menu">
			<ul class="nav navbar-nav" id="categories"></ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a data-toggle="modal" data-target="#create-category">Create
					Category</a></li>
				<li><a href="/clock" target="_blank">Clock</a></li>
			</ul>
		</div>
	</div>
</nav>

<div class="container">
	<div class="row">
		<div class="col-lg-12">
			<h1 id="category-title"></h1>
			<div id="timers"></div>
			<div id="timer"><span id="hours">00</span>:<span
					 id="minutes">00</span>:<span
					 id="seconds">00</span></div>
		</div>
	</div>
</div>

<div class="modal fade" id="create-category">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-body">
				<form>
					<div class="form-group">
						<input type="text" class="form-control" id="category-name"
						       placeholder="Category">
					</div>
				</form>
				<button class="btn btn-primary btn-block" onclick="createCategory()">
					Create
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="create-timer">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-body">
				<form style="width: 100%">
					<div class="form-group">
						<input type="text" class="form-control" id="timer-name"
						       placeholder="Timer Name">
					</div>
					<div class="form-inline">
						<input type="number" class="form-control" id="timer-hours"
						       placeholder="Hours">
						<input type="number" class="form-control" id="timer-minutes"
						       placeholder="Minutes">
						<input type="number" class="form-control" id="timer-seconds"
						       placeholder="Seconds">
					</div>
				</form>
				<button class="btn btn-primary btn-block" onclick="createTimer()">
					Create
				</button>
			</div>
		</div>
	</div>
</div>

<script
		 src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script
		 src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.2/socket.io.js"></script>
<script
		 src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
    var socket = io.connect('//' + document.domain + ':' + location.port);
    var categories = $('nav #categories');
    var timers = $('#timers');
    var title = $('#category-title');
    var currentCategory = null;

    getCategories();

    function deleteTimer(timer) {
        $.ajax({
            url: "//" + document.domain + ':' + location.port + "/timers/" + timer._id,
            dataType: "JSON",
            method: 'DELETE',
            success: function (data) {

            }
        });
    }

    function getCategories() {
        categories.empty();
        $.ajax({
            url: "//" + document.domain + ':' + location.port + "/categories",
            dataType: "JSON",
            success: function (data) {
                $.each(data, function (i, obj) {
                    var category = $('<a>');
                    category.text(obj.name);
                    category.click(function () {
                        getTimers(obj.name)
                    });
                    currentCategory = obj.name;
                    categories.append($('<li>').append(category));
                });
            }
        });
    }

    function getTimers(categoryName) {
        timers.empty();
        title.text(categoryName);
        $.ajax({
            url: "//" + document.domain + ':' + location.port + "/timers",
            dataType: "JSON",
            data: {category: categoryName},
            success: function (data) {
                $.each(data, function (i, timer) {
                    insertTimer(timer);
                })
            }
        }).done(function () {
            var b = $('<button class="btn btn-block btn-warning" data-toggle="modal" data-target="#create-timer">Create Timer</button>');
            $('#timers').append(b);
        });
    }

    function startTimer(timer) {
        socket.emit('start_timer', timer);
    }

    function insertTimer(timer) {
        var button = $('<button>');
        button.addClass('btn btn-success btn-block');
        button.click(function () {
            startTimer(timer)
        });
        button.append("<span class='pull-left'>" + timer.title + "</span>");

        if (timer.hours === undefined) {
            timer.hours = "00";
        }
        if (timer.minutes === undefined) {
            timer.minutes = "00";
        }
        if (timer.seconds === undefined) {
            timer.seconds = "00";
        }
        timer.hours = ("0" + timer.hours).slice(-2);
        timer.minutes = ("0" + timer.minutes).slice(-2);
        timer.seconds = ("0" + timer.seconds).slice(-2);

        var badge = $('<span>');
        badge.addClass('pull-right badge');
        badge.text(timer.hours + ":" + timer.minutes + ":" + timer.seconds);

        button.append(badge);
        $('#timers').append(button);
    }

    function createCategory() {
        var name = $('#category-name').val();
        $.ajax({
            method: "POST",
            url: "//" + document.domain + ':' + location.port + "/categories",
            dataType: "JSON",
            data: JSON.stringify({name: name}),
            success: function () {
                $('#create-category').modal('hide');
                getCategories();
            }
        });
    }

    function createTimer() {
        var name = $('#timer-name').val();
        var minutes = $('#timer-minutes').val();
        $.ajax({
            method: "POST",
            url: "//" + document.domain + ':' + location.port + "/timers",
            dataType: "JSON",
            data: JSON.stringify({
                title: name,
                minutes: minutes,
                category: currentCategory
            }),
            success: function () {
                $('#create-timer').modal('hide');
                getTimers(currentCategory);
            }
        });
    }

    socket.on('timer_changed', function (time) {
        $('#timer').css('color', 'black');
        $('#hours').text(("0" + time.hours).slice(-2));
        $('#minutes').text(("0" + time.minutes).slice(-2));
        $('#seconds').text(("0" + time.seconds).slice(-2));
        if (time.overtime) {
            $('#hours').text("+ " + ("0" + time.hours).slice(-2));
            $('#timer').css('color', 'red');
        }
    })

    $('#create-category')
</script>
</body>
</html>
